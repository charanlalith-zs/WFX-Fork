name: WFX Linux Build

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev, main]

jobs:
  build:
    name: Linux (${{ matrix.compiler }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - compiler: gcc
            cc: gcc
            cxx: g++
          - compiler: clang
            cc: clang
            cxx: clang++

    env:
      CCACHE_DIR: "${{ github.workspace }}/.ccache"
      CCACHE_MAXSIZE: "500M"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential clang ninja-build ccache

    - name: Restore Compiler Cache
      uses: actions/cache@v3
      with:
        path: .ccache
        # Key includes CMake files so OpenSSL rebuilds if version changes
        key: ccache-${{ matrix.compiler }}-${{ hashFiles('**/CMakeLists.txt', 'cmake/*.cmake') }}
        restore-keys: |
          ccache-${{ matrix.compiler }}-

    # Forces 'ssl_openssl.cmake' ExternalProject to use ccache
    - name: Setup Compiler Masquerade
      run: echo "/usr/lib/ccache" >> $GITHUB_PATH

    - name: Configure
      run: |
        cmake -S . -B build -G Ninja \
          -DCMAKE_C_COMPILER=${{ matrix.cc }} \
          -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build

  # Collector
  ci-success:
    name: WFX Linux Build Success
    runs-on: ubuntu-latest
    if: always()
    needs: [build] # Wait for the 'build' matrix to finish
    steps:
      - name: Check Status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" || "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "Build matrix failed."
            exit 1
          fi
          echo "All builds passed!"